name: Diff

# TODO
# Implement home-manager diff using
#   https://discourse.nixos.org/t/viewing-differences-between-flake-revisions/18768/2

on: [deployment_status]

env:
  environment: ${{ github.event.deployment_status.environment }}

jobs:
  check:
    runs-on: ubuntu-latest
    if: github.event.deployment_status.state == 'success'

    outputs:
      old_deployment: ${{ steps.deployments.outputs.sha }}
      new_deployment: ${{ github.sha }}

    steps:
      - name: Get Previous Deployment
        id: deployments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching deployments for repository: ${{ github.repository }}"
          echo "Environment: ${{ env.environment }}"
          deployments="$(gh api repos/${{ github.repository }}/deployments | jq -r '[.[] | select(.environment == "${{ env.environment }}")] | sort_by(.created_at) | reverse')"

          sha=""
          for deployment in $(echo "$deployments" | jq -r '.[].id'); do
            statuses="$(gh api "repos/${{ github.repository }}/deployments/${deployment}/statuses")"
            if echo "$statuses" | jq -e '.[] | select(.state == "inactive")' > /dev/null; then
              sha="$(echo "$deployments" | jq -r --arg id "$deployment" '.[] | select(.id == ($id | tonumber)) | .sha')"
              break
            fi
          done

          if [ -z "$sha" ]; then
            echo "No inactive deployment found."
          else
            echo "Found inactive deployment with SHA: $sha"
          fi

          echo "sha=$sha" >> "$GITHUB_OUTPUT"

  diff:
    runs-on: ubuntu-latest
    needs: check
    if: ${{ needs.check.outputs.old_deployment != '' }}

    steps:
      - name: Setup Nix
        uses: ElliottSullingeFarrall/dotfiles/.github/actions/setup@main

      - name: Build NixOS
        uses: Wandalen/wretry.action@v3.5.0
        env:
          host: ${{ env.environment }}
        with:
          command: |
            nix build --out-link old github:${{ github.repository}}/${{ needs.check.outputs.old_deployment }}#nixosConfigurations.${{ env.host }}.config.system.build.toplevel
            nix build --out-link new github:${{ github.repository}}/${{ needs.check.outputs.new_deployment }}#nixosConfigurations.${{ env.host }}.config.system.build.toplevel
            ls -la

      - name: Diff Builds
        run: nix run gitlab:khumba/nvd --no-write-lock-file -- diff old new > changes.diff

      - name: Upload Diff
        uses: actions/upload-artifact@v4
        with:
          name: changes
          path: changes.diff
